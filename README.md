

# MARVELO
MARVELO stands for Multicast Aware Routing for Virtual network Embedding with Loops in Overlays. MARVELO framework is a python-based solution used to distribute functions (let them be network or signal processing) among nodes in the wireless network and allow communications between the functinos. It is intended for transforming existing centralized implementations into distributed versions.
The distribution can be prepared manually (by creating or editing an XML file. See [an example for xml file](https://github.com/CN-UPB/MARVELO/blob/master/asn_server/bin/simParam/fobiExample/allocation.xml)) or auto-generated by giving MARVELO the available and required resources in CSV format (see [examples for CSV files](https://github.com/CN-UPB/MARVELO/tree/master/asn_server/bin/simParam/dummyExample). Auto-creating CSV files is in progress).

This framework has been tested on Raspberry Pi 3 (RPi3) and Debian distrubtions (Raspbian strech and Kali). Thus, the network can consists of Laptops instead of RPis. It also supports an emulation framework, where one device emulates the whole network. 
## Installation Requirements:
* Python 2.7 (Support for Python 3 is in progress)
* root access 
* Other system and python packages are found in the installation steps
## Quick Setup
There are two roles in MARVELO; Server(the brain who will distribute the blocks) and Client (who will run the process). For the sake of consistency, please make sure that you have user "asn" on your RPis
```sh
$ adduser asn
$ usermod -aG sudo asn
```

Note that this may be needed for the client but not necessary for the server. For a detailed setup steps, please check
https://www.uni-paderborn.de/asn/software/

### Server Installation
* *optional*: copy the **asn_server** folder to **/home/asn/**
* Download the required python packages 

                 
         $ sudo apt-get install  python    python-pip    python-dev    build-essential    ntp    ntpdate    rsync    python-lxml python-tk  
        
         $ pip install netifaces pyomo pandas
         
       
* Setup the ad-hoc network. If you have limited knowledge, here is a quick setup for ad-hoc network
  * change the network configuration of wireless interface 
         ```
      $ sudo nano /etc/network/interfaces
         ```
  *  comment your wireless interface config (letâ€™s say ***wlan0***) and replace it with
  ``` 
       iface wlan0  inet static
            address 10.1.1.254
            netmask 255.255.255.0
            wireless-channel 1
            wireless-essid marvelo_network
            wireless-mode ad-hoc
  

### Client installation

* Copy **asn_daemon** folder to **/home/asn/**
* Download packages needed to run the daemon (and some demos for testing)
     ```
     $ sudo apt-get install  python    python-pip    python-dev    build-essential    ntp    ntpdate    rsync    systemd    python-lxml    python-scipy 
      
     $ pip install numpy netifaces 
     ```
* Setup the ad-hoc network. Similar to the server, edit `/etc/network/interfaces`  and choose an IP in the same subnet for your network. Example 
```                        
      allow-hotplug wlan0
      iface wlan0 inet static
            address 10.1.1.101
            netmask 255.255.255.0
            wireless-channel 1
            wireless-essid marvelo_network
            wireless-mode ad-hoc
```
* Add the daemon as a service and make it start at reboot
  *  copy the file `asn_server/ansible/ templates/asn_daemon.service.j2`to `/etc/systemd/system/asn_daemon.service` [on the client]
  * run the following commands on the client:
      ```
      $sudo systemctl start asn_daemon  
      $sudo systemctl enable asn_daemon
      ```
  * *Post Check:* to make sure that the daemon is running in the background, check if it is active using:
      ``` 
      $ sudo service asn_daemon status
      ```
 ### Emulator setup
You can use a single device as a server and client, while the communications rely on the logical interfaces (multiple loopbacks). We show here how to use the default loopback *lo (127.0.0.1)*

* make sure that you have **asn** user on the device and you have downloaded the required packages of both client and server ([see above](#server-installation))
* Copy **asn_daemon** folder to **/home/asn/** and
 ```cd /home/asn/asn_daemon```
* to start the daemon run
``` $sudo python daemon.py -if $logicalInterface```
In this example, our *logicalInterface* is *lo*
``` $sudo python daemon.py -if lo```  

## Test with a Demo
We try an example using the emulator (using different devices require only changing the IP address in the XML files). This example uses ICA for source separation. The original audios can be found in **asn_server/Demos/system/fobi/mix1.wav**
* Go to the directory of the **asn_server**
* run ``` python server.py```
* Then, execute the following commands in MARVELO (one by one)
     ```
      setxml Demos/topology/SourceSeparation/ica_b_local.xml
      transferdata 
      connect
      start
     
     ```
 Note: You will be asked for the password for **asn** user each time you type a command. As a workaround you can add the public key in the authorized hosts ```~/.ssh/authorized_keys ```
* to collect the log files from the server, run in MARVELO
    ``` getlogs```
    a new folder will be created in **asn_server/logs** with the collected files. You will find 2 audio files for each speaker
 
